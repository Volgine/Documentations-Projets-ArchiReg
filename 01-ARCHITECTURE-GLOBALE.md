# üèóÔ∏è ARCHITECTURE GLOBALE ARCHIREG

**Date** : 15 octobre 2025  
**Version** : 5.0 R√âORGANIS√âE  
**Status** : ‚úÖ EN PRODUCTION

---

## üéØ VUE D'ENSEMBLE

ArchiReg est une **plateforme RAG (Retrieval-Augmented Generation)** pour l'analyse de documents juridiques (L√©gifrance).

**Architecture** : 6 services principaux + Supabase

```
Micro-service L√©gifrance
    ‚Üì Collecte API PISTE
Bucket Supabase Storage (259 fichiers)
    ‚Üì files_queue
Workers (Global + Chunks)
    ‚Üì Parse + GGUF Embeddings
pgvector (312k docs + 0 chunks)
    ‚Üì HNSW Index (383 MB)
Backend RAG
    ‚Üì Groq LLM + Streaming
Frontend Chat
```

---

## üìä SCH√âMA ARCHITECTURE COMPL√àTE

```mermaid
graph TB
    subgraph "1Ô∏è‚É£ COLLECTE DONN√âES"
        MS[Micro-service L√©gifrance<br/>FastAPI + API PISTE]
        BKT[Bucket Supabase Storage<br/>agentbasic-legifrance-raw<br/>259 fichiers, 17 MB]
        FQ[files_queue<br/>259 rows]
        
        MS -->|Upload JSON| BKT
        MS -->|INSERT| FQ
    end
    
    subgraph "2Ô∏è‚É£ TRAITEMENT: WORKERS LOCAUX"
        WL[WorkerLocal x3<br/>‚úÖ TERMIN√â<br/>312k docs]
        WLC[WorkerLocal Chunk x3<br/>‚è∏Ô∏è PR√äT<br/>0 chunks]
        
        FQ -->|SELECT pending| WL
        FQ -.->|SELECT pending_chunk| WLC
        
        WL -->|Parse + GGUF Embedding GLOBAL| DOCS[documents<br/>312k rows<br/>850 MB]
        WLC -.->|Parse + Chunk + GGUF| CHUNKS[document_chunks<br/>0 rows ‚Üí 6M]
        
        DOCS -->|Vecteurs 768 dims| HNSW[pgvector + HNSW<br/>Index 383 MB]
        CHUNKS -.->|Vecteurs 768 dims| HNSW
    end
    
    subgraph "3Ô∏è‚É£ BACKEND: RAG + CHAT"
        BE[Backend Agent-Orchestrator<br/>FastAPI + Hypercorn HTTP/2]
        GROQ[Groq API<br/>llama-3.3-70b-versatile]
        GGUF[GGUF Model Local<br/>Solon-embeddings-large<br/>768 dims]
        
        BE -->|READ ONLY| HNSW
        BE -->|G√©n√®re embedding query| GGUF
        BE -->|Recherche vectorielle| HNSW
        BE -->|Chat LLM streaming| GROQ
    end
    
    subgraph "4Ô∏è‚É£ FRONTEND + EDGE FUNCTIONS"
        FE[Frontend Next.js<br/>Vercel]
        EDGE[Edge Functions Supabase<br/>admin-stats, cron-manager, system-tests]
        
        FE -->|Chat streaming SSE| BE
        FE -->|Admin m√©triques| EDGE
        EDGE -->|SELECT admin_metrics_view| HNSW
    end
    
    style MS fill:#f59e0b
    style WL fill:#4ecdc4
    style WLC fill:#95e1d3,stroke-dasharray: 5 5
    style BE fill:#ff6b6b
    style FE fill:#60a5fa
    style EDGE fill:#4ade80
    style HNSW fill:#ef4444
    style GGUF fill:#ffd93d
    style BKT fill:#ffd93d
```

---

## üîÑ FLUX DE DONN√âES PRINCIPAUX

### **1. Flux Chat Utilisateur** üí¨

```mermaid
sequenceDiagram
    participant U as Utilisateur
    participant FE as Frontend
    participant BE as Backend
    participant GGUF as GGUF Service
    participant PG as pgvector
    participant GROQ as Groq API
    
    U->>FE: "Qu'est-ce qu'un PLU ?"
    FE->>BE: POST /api/v3/chat/streaming
    
    Note over BE: 1. Recherche RAG
    BE->>GGUF: generate_embedding(query)
    GGUF-->>BE: embedding[768]
    BE->>PG: SELECT ... <=> embedding LIMIT 5
    PG-->>BE: 5 documents pertinents
    
    Note over BE: 2. Construire contexte
    BE->>BE: build_context(docs)
    
    Note over BE: 3. Stream LLM
    BE->>GROQ: stream(context + query)
    loop Streaming SSE
        GROQ-->>BE: chunk
        BE-->>FE: data: {chunk}
        FE-->>U: Affiche chunk
    end
    
    Note over BE: 4. Sauvegarder
    BE->>PG: INSERT conversations/messages
```

**Latence** :
- RAG search : <250ms
- Stream TTFB : <500ms
- Total : <1s ‚úÖ

---

### **2. Flux Admin Dashboard** üìä

```mermaid
sequenceDiagram
    participant A as Admin
    participant FE as Frontend
    participant EF as Edge Function
    participant DB as Supabase DB
    
    A->>FE: Ouvre /admin
    FE->>EF: GET /functions/v1/admin-stats?action=get
    
    Note over EF: Auth 100ms (m√™me datacenter)
    EF->>DB: SELECT * FROM admin_metrics_view
    Note over DB: Vue mat√©rialis√©e (refresh 10min auto)
    DB-->>EF: 21 m√©triques
    EF-->>FE: JSON metrics
    FE-->>A: Dashboard (4 onglets)
    
    Note over A: Click "Actualiser"
    A->>FE: Click bouton
    FE->>EF: GET /functions/v1/admin-stats?action=refresh
    EF->>DB: REFRESH MATERIALIZED VIEW
    Note over DB: 5.9s (optimis√©)
    DB-->>EF: Vue refresh√©e
    EF->>DB: SELECT * FROM admin_metrics_view
    DB-->>EF: Nouvelles donn√©es
    EF-->>FE: M√©triques √† jour
    FE-->>A: Dashboard actualis√©
```

**Performance** :
- Latence Edge : 1-2s
- Auth : <100ms (vs 30-40s avant)
- Gain : -99.7% latence ‚úÖ

---

### **3. Flux Collecte L√©gifrance** üì•

```mermaid
sequenceDiagram
    participant API as API PISTE
    participant MS as Micro-service
    participant BKT as Bucket
    participant FQ as files_queue
    
    Note over MS: Mode MAINTENANCE (CRON 2h)
    MS->>API: OAuth2 token
    API-->>MS: access_token
    
    loop Pour 5 codes prioritaires
        MS->>API: POST /legi/tableMatieres
        API-->>MS: {sections: [...]}
        
        MS->>MS: extract_article_ids_recursive()<br/>Filtre LEGIARTI
        
        loop Pour chaque article LEGIARTI
            MS->>API: POST /consult/getArticle
            API-->>MS: {article: {texteHtml}}
            
            MS->>MS: Clean HTML<br/>Filtre > 200 chars
            
            alt Texte valide
                MS->>BKT: Upload JSON
                MS->>FQ: INSERT status=pending
            else Texte invalide
                MS->>MS: Ignorer
            end
        end
    end
    
    Note over MS,FQ: 259 fichiers collect√©s (qualit√© 100%)
```

**Modes** :
- **MAINTENANCE** : 5 codes, CRON 2h, ~250 articles/run
- **MASSIVE** : 20 codes, interval 10min, ~1000 articles/run

**Filtres qualit√©** :
1. ‚úÖ LEGIARTI uniquement (ignore LEGISCTA)
2. ‚úÖ Texte > 200 chars minimum

---

### **4. Flux Workers Global** üîß

```mermaid
sequenceDiagram
    participant FQ as files_queue
    participant WL as WorkerLocal
    participant BKT as Bucket
    participant GGUF as GGUF Service
    participant DB as documents table
    
    loop Boucle infinie
        WL->>FQ: SELECT * WHERE status=pending LIMIT 100
        FQ-->>WL: 100 fichiers
        
        loop Pour chaque fichier
            WL->>BKT: Download JSON
            BKT-->>WL: content
            
            WL->>WL: Parse document
            
            WL->>GGUF: generate(content)
            GGUF-->>WL: embedding[768]
            
            WL->>DB: INSERT document + embedding
            WL->>FQ: UPDATE status=processed
        end
    end
    
    Note over WL,DB: 312k documents trait√©s ‚úÖ
```

**Performance** :
- 3 workers simultan√©s
- 37.5 fichiers/s total
- Taux erreur <0.03%

---

### **5. Flux Workers Chunk** üß©

```mermaid
sequenceDiagram
    participant FQ as files_queue
    participant WLC as WorkerLocal Chunk
    participant BKT as Bucket
    participant CHUNK as Chunker
    participant GGUF as GGUF Service
    participant DB as document_chunks
    
    loop Boucle infinie
        WLC->>FQ: SELECT * WHERE status=pending_chunk LIMIT 50
        FQ-->>WLC: 50 fichiers
        
        loop Pour chaque fichier
            WLC->>BKT: Download JSON
            BKT-->>WLC: content
            
            WLC->>WLC: Parse document
            
            WLC->>CHUNK: chunk_document(content)
            CHUNK-->>WLC: [chunk1, chunk2, ..., chunkN]
            
            loop Pour chaque chunk
                WLC->>GGUF: generate(chunk)
                GGUF-->>WLC: embedding[768]
                
                WLC->>DB: INSERT chunk + embedding
            end
            
            WLC->>FQ: UPDATE status=processed_chunk
        end
    end
    
    Note over WLC,DB: 0 chunks (‚è∏Ô∏è Pr√™t, pas lanc√©)
```

**Estimations** :
- 6M chunks attendus (ratio 1:20)
- Chunk size : 500-1000 tokens
- Overlap : 10%

---

## üéØ SERVICES D√âTAILL√âS

### **1. Frontend (ArchiReg-Front)** üé®

**Stack** : Next.js 14 + React 18 + TypeScript  
**Host** : Vercel  
**URL** : https://archi-reg-front.vercel.app

**Features** :
- ‚úÖ Chat streaming SSE + Markdown
- ‚úÖ Dashboard admin (4 onglets, 21 m√©triques)
- ‚úÖ Tests syst√®me (27 tests)
- ‚úÖ Supabase Auth + Realtime

**Doc** : [04-ArchiReg-Front/](./04-ArchiReg-Front/)

---

### **2. Backend (Agent-Orchestrator)** ü§ñ

**Stack** : FastAPI + Python 3.11 + Hypercorn HTTP/2  
**Host** : Render.com (Starter Plan)  
**URL** : https://agent-orchestrateur-backend.onrender.com

**Responsabilit√©s** :
- ‚úÖ Chat Groq LLM (streaming SSE)
- ‚úÖ RAG pgvector (<250ms)
- ‚úÖ Embeddings GGUF locaux
- ‚úÖ Proxy micro-service L√©gifrance
- ‚úÖ 9 tests Backend

**Stats** :
- 312k documents index√©s
- Latence RAG <250ms
- Recall >95%

**Doc** : [03-Agent-Orchestrator/](./03-Agent-Orchestrator/)

---

### **3. Micro-service L√©gifrance** üì•

**Stack** : FastAPI + Python 3.11  
**Host** : Render.com (Free tier)  
**URL** : https://micro-service-data-legifrance-piste.onrender.com

**Responsabilit√©s** :
- ‚úÖ Collecte API PISTE L√©gifrance
- ‚úÖ OAuth2 + Rate limiting (60 req/s)
- ‚úÖ Upload direct bucket Supabase
- ‚úÖ Auto-sync files_queue
- ‚úÖ Persistance √©tat scheduler

**Modes** :
- **MAINTENANCE** (actif) : 5 codes, CRON 2h
- **MASSIVE** : 20 codes, interval 10min

**Filtres qualit√©** :
- ‚úÖ LEGIARTI uniquement
- ‚úÖ Texte > 200 chars

**Stats** :
- 259 fichiers collect√©s (post-fix qualit√©)
- Qualit√© 100% (vs 90% erreurs avant)

**Doc** : [02-Micro-service-Legifrance/](./02-Micro-service-Legifrance/)

---

### **4. WorkerLocal (x3)** üîß

**Stack** : Python 3.11 + llama-cpp-python  
**Host** : PC Windows local  

**Responsabilit√©s** :
- ‚úÖ Parse JSON L√©gifrance
- ‚úÖ G√©n√®re embeddings GLOBAUX (document entier)
- ‚úÖ INSERT documents + pgvector

**Stats** :
- ‚úÖ 312k documents trait√©s
- ‚úÖ 37.5 fichiers/s (3 workers)
- ‚úÖ Taux erreur <0.03%

**Doc** : [05-WorkerLocal/](./05-WorkerLocal/)

---

### **5. WorkerLocal Chunk (x3)** üß©

**Stack** : Python 3.11 + llama-cpp-python + tiktoken  
**Host** : PC Windows local  

**Responsabilit√©s** :
- ‚è∏Ô∏è Parse + Chunking s√©mantique
- ‚è∏Ô∏è G√©n√®re embeddings GRANULAIRES (chunks)
- ‚è∏Ô∏è INSERT document_chunks + pgvector

**Estimations** :
- ~6M chunks (ratio 1:20)
- Chunk size : 500-1000 tokens
- Overlap : 10%
- Status : ‚è∏Ô∏è Pr√™t (pas encore lanc√©)

**Doc** : [06-WorkerLocal-Chunk/](./06-WorkerLocal-Chunk/)

---

### **6. Supabase** üóÑÔ∏è

**Services** : PostgreSQL 17.6 + pgvector + Storage + Auth + Edge Functions  
**Plan** : Pro (25‚Ç¨/mois)  
**R√©gion** : EU Central 1 (Frankfurt)

**Infrastructure** :
- **Database** : 6.7 GB / 100 GB (7% usage)
- **Storage** : 5 GB / 100 GB (5% usage)
- **Compute** : Micro 1GB 2-core ARM
- **Connexions** : 25 / 60 max (42% usage)

**Tables principales** :
- `files_queue` : 259 rows (231 pending)
- `documents` : 312k rows + embeddings (850 MB)
- `document_chunks` : 0 rows (pr√™t pour 6M)
- `parsed_files` : 312k rows (tracking)
- `conversations` : ~500 rows
- `messages` : ~2k rows

**Edge Functions** :
- `admin-stats` : M√©triques dashboard
- `cron-manager` : Gestion pg_cron
- `system-tests` : 18 tests Edge

**Doc** : [01-Supabase/](./01-Supabase/)

---

## üìà STATISTIQUES ACTUELLES (15 Oct 2025)

### **Donn√©es Collect√©es**

| M√©trique | Valeur | Notes |
|----------|--------|-------|
| **Fichiers bucket** | 259 | Post-fix LEGIARTI ‚úÖ |
| **Files queue** | 259 (231 pending) | Auto-sync ‚úÖ |
| **Documents pars√©s** | 312,000 | WorkerLocal termin√© ‚úÖ |
| **Embeddings g√©n√©r√©s** | 312,000 (768 dims) | GGUF ‚úÖ |
| **Chunks** | 0 | WorkerLocal Chunk pr√™t ‚è∏Ô∏è |

### **Performance Syst√®me**

| Service | M√©trique | Valeur | Status |
|---------|----------|--------|--------|
| **Backend RAG** | Latence | <250ms | ‚úÖ |
| **Groq LLM** | TTFB | <500ms | ‚úÖ |
| **Edge Functions** | Latence | 1-2s | ‚úÖ |
| **Workers** | Vitesse | 37.5 fichiers/s | ‚úÖ |
| **HNSW Index** | Recall | >95% | ‚úÖ |

### **Base de Donn√©es**

| Table | Rows | Size | Index HNSW |
|-------|------|------|------------|
| `documents` | 312,000 | 850 MB | 383 MB (m=16) ‚úÖ |
| `document_chunks` | 0 | 3.6 MB | Pr√™t (m=24) ‚è∏Ô∏è |
| `files_queue` | 259 | 296 kB | - |
| `parsed_files` | 312,000 | 372 MB | - |

**Usage total** : ~1.5 GB / 8 GB (18.75%)

---

## üîê S√âCURIT√â

### **Authentification**

```
Frontend ‚Üí Supabase Auth (JWT)
    ‚Üì
Backend ‚Üí JWT validation + auth.role()
    ‚Üì
Edge Functions ‚Üí Service Role Key + admin check
    ‚Üì
Database ‚Üí RLS Policies (28 tables)
```

**R√¥les** :
- `authenticated` : Utilisateurs connect√©s
- `admin` : Admins (app_metadata.role)
- `service_role` : Services backend/workers

### **RLS Policies**

- ‚úÖ 28 tables avec RLS activ√©
- ‚úÖ Policies optimis√©es `(select auth.role())`
- ‚úÖ Service role only sur vues mat√©rialis√©es
- ‚úÖ Pas d'acc√®s direct frontend (anon key)

**Doc** : [01-Supabase/04-RLS-POLICIES.md](./01-Supabase/04-RLS-POLICIES.md)

---

## üõ†Ô∏è WORKFLOWS D√âPLOIEMENT

### **Frontend (Vercel)**

```bash
cd Frontend/
git add .
git commit -m "feat: nouvelle feature"
git push origin main
npx vercel --prod
```

**Autodeploy** : ‚úÖ Push ‚Üí Vercel build automatique

---

### **Backend (Render)**

```bash
cd Agent-Orchestrator/
git add backend/
git commit -m "fix: correction bug"
git push origin main
# Render autodeploy via webhook GitHub
```

**Autodeploy** : ‚úÖ Push ‚Üí Render build automatique

---

### **Micro-service (Render)**

```bash
cd Micro-service-data-legifrance-piste/
git add app/
git commit -m "refactor: optimisation"
git push origin main
# Render autodeploy via webhook GitHub
```

**Autodeploy** : ‚úÖ Push ‚Üí Render build automatique

---

### **Workers (Local)**

```batch
# Lancer WorkerLocal
cd WorkerLocal\launch\
worker_1.bat  # Worker 1
worker_2.bat  # Worker 2
worker_3.bat  # Worker 3

# Lancer WorkerLocal Chunk
cd "WorkerLocal Chunk\launch\"
worker_chunk_1.bat  # Worker Chunk 1
worker_chunk_2.bat  # Worker Chunk 2
worker_chunk_3.bat  # Worker Chunk 3
```

**Manuel** : Lancement local Windows

---

## üìö DOCUMENTATION TECHNIQUE

### **Structure Documentation**

```
DOCS-ARCHITECTURE/
‚îú‚îÄ‚îÄ README.md                      ‚Üê START HERE
‚îú‚îÄ‚îÄ 00-INDEX.md                    ‚Üê Navigation compl√®te
‚îú‚îÄ‚îÄ 01-ARCHITECTURE-GLOBALE.md     ‚Üê CE FICHIER
‚îú‚îÄ‚îÄ 02-INFRASTRUCTURE.md           ‚Üê URLs services
‚îú‚îÄ‚îÄ 03-BONNES-PRATIQUES.md         ‚Üê Best practices
‚îÇ
‚îú‚îÄ‚îÄ 01-Supabase/                   ‚Üê 16 fichiers + INDEX
‚îú‚îÄ‚îÄ 02-Micro-service-Legifrance/   ‚Üê 6 fichiers + INDEX
‚îú‚îÄ‚îÄ 03-Agent-Orchestrator/         ‚Üê 5 fichiers + INDEX
‚îú‚îÄ‚îÄ 04-ArchiReg-Front/             ‚Üê 2 fichiers
‚îú‚îÄ‚îÄ 05-WorkerLocal/                ‚Üê 3 fichiers
‚îî‚îÄ‚îÄ 06-WorkerLocal-Chunk/          ‚Üê 2 fichiers
```

### **Liens Documentation**

- **Supabase** ‚Üí [01-Supabase/README.md](./01-Supabase/README.md)
- **Micro-service** ‚Üí [02-Micro-service-Legifrance/README.md](./02-Micro-service-Legifrance/README.md)
- **Backend** ‚Üí [03-Agent-Orchestrator/README.md](./03-Agent-Orchestrator/README.md)
- **Frontend** ‚Üí [04-ArchiReg-Front/README.md](./04-ArchiReg-Front/README.md)
- **WorkerLocal** ‚Üí [05-WorkerLocal/README.md](./05-WorkerLocal/README.md)
- **WorkerLocal Chunk** ‚Üí [06-WorkerLocal-Chunk/README.md](./06-WorkerLocal-Chunk/README.md)

---

## üîß FIXES CRITIQUES APPLIQU√âS

### **1. Fix Embeddings Incompatibles** (13 oct 2025)

**Probl√®me** : Workers (Windows AVX2) ‚â† Backend (Linux no-AVX2)

**Solution** : Compilation source sans AVX2/FMA
```bash
pip install --no-binary=llama-cpp-python llama-cpp-python
```

**R√©sultat** : ‚úÖ RAG fonctionne (0 ‚Üí 312k documents trouv√©s)

**Doc** : [05-WorkerLocal/FIX-EMBEDDINGS-INCOMPATIBLES.md](./05-WorkerLocal/FIX-EMBEDDINGS-INCOMPATIBLES.md)

---

### **2. Fix Pool Asyncpg** (13 oct 2025)

**Probl√®me** : `{:shutdown, :client_termination}` sur RAG search

**Solution** : Pool asyncpg + Supavisor Session Mode (port 5432)

**R√©sultat** : ‚úÖ Connexions stables + latence <200ms

**Doc** : [03-Agent-Orchestrator/04-FIX-ASYNCPG-POOL.md](./03-Agent-Orchestrator/04-FIX-ASYNCPG-POOL.md)

---

### **3. Fix Qualit√© Collecte LEGIARTI** (15 oct 2025)

**Probl√®me** : 90% documents vides (LEGISCTA vs LEGIARTI)

**Solution** : Filtre LEGIARTI + minimum 200 chars

**R√©sultat** : ‚úÖ Qualit√© collecte 100% (1.47M ‚Üí 259 fichiers valides)

**Doc** : [02-Micro-service-Legifrance/06-FIX-LEGIARTI-v3.0.md](./02-Micro-service-Legifrance/06-FIX-LEGIARTI-v3.0.md)

---

## üöÄ PROCHAINES √âTAPES

### **Phase 1 : Compl√©ter WorkerLocal** ‚è∏Ô∏è

- ‚úÖ 312k documents trait√©s
- ‚è∏Ô∏è 231 fichiers pending restants
- ‚è∏Ô∏è Mode MASSIVE optionnel (20 codes ‚Üí 50-100k articles)

### **Phase 2 : Lancer WorkerLocal Chunk** ‚è∏Ô∏è

- ‚úÖ Workers d√©velopp√©s et test√©s
- ‚è∏Ô∏è Lancer 3 workers simultan√©s
- ‚è∏Ô∏è G√©n√©ration 6M chunks
- ‚è∏Ô∏è Construction index HNSW (m=24)

### **Phase 3 : RAG Hybride** üîÆ

- ‚è∏Ô∏è Recherche globale (documents)
- ‚è∏Ô∏è Recherche granulaire (chunks)
- ‚è∏Ô∏è Combinaison r√©sultats
- ‚è∏Ô∏è Citations pr√©cises passages

---

## üéâ CONCLUSION

**ArchiReg v5.0** :
- ‚úÖ 6 services d√©ploy√©s et document√©s
- ‚úÖ 312k documents RAG index√©s
- ‚úÖ Architecture micro-services
- ‚úÖ Performance optimis√©e
- ‚úÖ Qualit√© collecte 100%
- ‚úÖ Documentation r√©organis√©e

**Syst√®me production-ready !** üöÄ

